<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pen Tool - Canvas Renderer</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: #f5f5f5;
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 280px;
      background: #ffffff;
      border-right: 1px solid #e0e0e0;
      padding: 20px;
      overflow-y: auto;
    }

    .canvas-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #ffffff;
    }

    canvas {
      border: 1px solid #e0e0e0;
      background: #ffffff;
      cursor: crosshair;
    }

    h1 {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
    }

    .section {
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      color: #666;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }

    .button {
      width: 100%;
      padding: 10px 15px;
      margin-bottom: 8px;
      background: #0066FF;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: background 0.2s;
    }

    .button:hover {
      background: #0052CC;
    }

    .button.secondary {
      background: #f0f0f0;
      color: #333;
    }

    .button.secondary:hover {
      background: #e0e0e0;
    }

    .button:disabled {
      background: #e0e0e0;
      color: #999;
      cursor: not-allowed;
    }

    .info {
      font-size: 12px;
      color: #666;
      line-height: 1.6;
      padding: 12px;
      background: #f8f8f8;
      border-radius: 6px;
    }

    .state-indicator {
      display: inline-block;
      padding: 3px 8px;
      background: #e3f2fd;
      color: #1976d2;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .renderer-badge {
      display: inline-block;
      padding: 3px 8px;
      background: #e8f5e9;
      color: #2e7d32;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .keyboard-shortcuts {
      font-size: 11px;
      color: #666;
      line-height: 1.8;
    }

    .shortcut {
      display: flex;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .key {
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 10px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h1>üñäÔ∏è Pen Tool <span class="renderer-badge">Canvas</span></h1>

    <div class="section">
      <div class="section-title">Status</div>
      <div class="info">
        Renderer: <span class="renderer-badge">Canvas 2D</span><br>
        State: <span class="state-indicator" id="state">IDLE</span>
      </div>
    </div>

    <div class="section">
      <div class="section-title">Actions</div>
      <button class="button" id="toggleMode">Switch to Edit Mode</button>
      <button class="button secondary" id="viewMode">View Mode</button>
      <button class="button secondary" id="clearPaths">Clear All Paths</button>
      <button class="button secondary" id="closePath" disabled>Close Current Path</button>
    </div>

    <div class="section">
      <div class="section-title">Instructions</div>
      <div class="info">
        <strong>Drawing Mode:</strong><br>
        ‚Ä¢ Click to add straight points<br>
        ‚Ä¢ Click & drag to create curves<br>
        ‚Ä¢ Hold <span class="key">Shift</span> for angle constraints<br>
        ‚Ä¢ Hold <span class="key">Alt</span> for independent handles<br>
        ‚Ä¢ Click on first point to close path<br>
        <br>
        <strong>Edit Mode:</strong><br>
        ‚Ä¢ Click & drag anchor points to move<br>
        ‚Ä¢ Click & drag handles to adjust curves<br>
        ‚Ä¢ Hold <span class="key">Alt</span> while dragging for independent control<br>
        ‚Ä¢ Double-click on path to add points<br>
        ‚Ä¢ Select points and press <span class="key">Delete</span> to remove
      </div>
    </div>

    <div class="section">
      <div class="section-title">Keyboard Shortcuts</div>
      <div class="keyboard-shortcuts">
        <div class="shortcut">
          <span>Constrain angle</span>
          <span class="key">Shift</span>
        </div>
        <div class="shortcut">
          <span>Independent handles</span>
          <span class="key">Alt</span>
        </div>
        <div class="shortcut">
          <span>Close path</span>
          <span class="key">Enter</span>
        </div>
        <div class="shortcut">
          <span>Finish path</span>
          <span class="key">Esc</span>
        </div>
        <div class="shortcut">
          <span>Delete point</span>
          <span class="key">Delete</span>
        </div>
      </div>
    </div>
  </div>

  <div class="canvas-container">
    <canvas id="canvas" width="800" height="600"></canvas>
  </div>

  <script type="module">
    import { 
      PathManager, 
      PenTool, 
      EditMode, 
      CanvasPathRenderer,
      PenToolState 
    } from '../dist/index.esm.js';

    // Initialize
    const canvas = document.getElementById('canvas');
    const pathManager = new PathManager();
    const renderer = new CanvasPathRenderer(canvas, pathManager);
      showAllHandles: false
    });

    let currentMode = 'pen'; // 'pen', 'edit', or 'view'
    let penTool = null;
    let editMode = null;

    // Create pen tool
    function initPenTool() {
      penTool = new PenTool(pathManager, {}, {
        onPathModified: (path) => {
          renderer.update(pathManager);
          updateUI();
        },
        onStateChange: (state) => {
          document.getElementById('state').textContent = state.toUpperCase();
          updateUI();
        },
        onClosePathHover: (canClose) => {
          if (canClose && penTool.getCurrentPath()) {
            const firstPoint = penTool.getCurrentPath().anchorPoints[0];
            renderer.renderClosePathIndicator(firstPoint.position, true);
          } else {
            renderer.renderClosePathIndicator({ x: 0, y: 0 }, false);
          }
          renderer.update(pathManager);
        }
      });
    }

    // Create edit mode
    function initEditMode() {
      editMode = new EditMode(pathManager, {
        onPathModified: (path) => {
          renderer.update(pathManager);
        },
        onSelectionChange: (points) => {
          renderer.setOptions({ showAllHandles: points.length > 0 });
          renderer.update(pathManager);
        },
        onHoverPreview: (point, path) => {
          renderer.renderHoverPreviewPoint(point);
          renderer.update(pathManager);
        }
      });
    }

    initPenTool();
    initEditMode();

    // Mouse event handlers
    let mousePosition = { x: 0, y: 0 };

    function getMousePosition(event) {
      const rect = canvas.getBoundingClientRect();
      return {
        x: event.clientX - rect.left,
        y: event.clientY - rect.top
      };
    }

    canvas.addEventListener('mousedown', (e) => {
      mousePosition = getMousePosition(e);
      
      if (currentMode === 'pen') {
        penTool.onMouseDown(mousePosition);
      } else {
        editMode.onMouseDown(mousePosition);
      }
    });

    canvas.addEventListener('mousemove', (e) => {
      mousePosition = getMousePosition(e);
      
      if (currentMode === 'pen') {
        penTool.onMouseMove(mousePosition);
        
        // Render preview line or curve if drawing
        const path = penTool.getCurrentPath();
        if (path && path.anchorPoints.length > 0 && penTool.getState() === PenToolState.Drawing) {
          const lastPoint = path.anchorPoints[path.anchorPoints.length - 1];
          
          // If last point has handleOut, show curve preview
          if (lastPoint.handleOut?.visible) {
            const handleOutPos = {
              x: lastPoint.position.x + lastPoint.handleOut.position.x,
              y: lastPoint.position.y + lastPoint.handleOut.position.y
            };
            // Use mouse position as control point 2 (curve comes straight into cursor)
            renderer.renderPreviewCurve(lastPoint.position, handleOutPos, mousePosition, mousePosition);
          } else {
            renderer.renderPreviewLine(lastPoint.position, mousePosition);
          }
          renderer.update(pathManager);
        }
      } else {
        editMode.onMouseMove(mousePosition);
      }
    });

    canvas.addEventListener('mouseup', (e) => {
      mousePosition = getMousePosition(e);
      
      if (currentMode === 'pen') {
        penTool.onMouseUp(mousePosition);
      } else {
        editMode.onMouseUp(mousePosition);
      }
    });

    canvas.addEventListener('dblclick', (e) => {
      if (currentMode === 'edit') {
        mousePosition = getMousePosition(e);
        editMode.onDoubleClick(mousePosition);
      }
    });

    // Keyboard event handlers
    window.addEventListener('keydown', (e) => {
      if (currentMode === 'pen') {
        penTool.onKeyDown(e.key);
      } else {
        editMode.onKeyDown(e.key);
      }
    });

    window.addEventListener('keyup', (e) => {
      if (currentMode === 'pen') {
        penTool.onKeyUp(e.key);
      } else {
        editMode.onKeyUp(e.key);
      }
    });

    // UI Controls
    document.getElementById('toggleMode').addEventListener('click', () => {
      if (currentMode === 'pen') {
        currentMode = 'edit';
        document.getElementById('toggleMode').textContent = 'Switch to Draw Mode';
        document.getElementById('state').textContent = 'EDIT MODE';
        canvas.style.cursor = 'default';
        renderer.setOptions({ showAllHandles: true });
        renderer.clearPreview();
        penTool.reset();
      } else {
        currentMode = 'pen';
        document.getElementById('toggleMode').textContent = 'Switch to Edit Mode';
        document.getElementById('state').textContent = 'IDLE';
        canvas.style.cursor = 'crosshair';
        renderer.setOptions({ showAllHandles: false });
      }
      renderer.update(pathManager);
    });

    document.getElementById('viewMode').addEventListener('click', () => {
      currentMode = 'view';
      document.getElementById('state').textContent = 'VIEW MODE';
      canvas.style.cursor = 'default';
      penTool.reset();
      editMode.clearSelection();
      renderer.renderViewOnly(pathManager);
    });

    document.getElementById('clearPaths').addEventListener('click', () => {
      const paths = pathManager.getAllPaths();
      paths.forEach(path => pathManager.removePath(path.id));
      renderer.clear();
      penTool.reset();
      updateUI();
    });

    document.getElementById('closePath').addEventListener('click', () => {
      const path = penTool.getCurrentPath();
      if (path) {
        pathManager.closePath(path);
        renderer.update(pathManager);
        penTool.reset();
        updateUI();
      }
    });

    function updateUI() {
      const canClose = penTool.getCurrentPath() && penTool.getCurrentPath().anchorPoints.length > 2;
      document.getElementById('closePath').disabled = !canClose;
    }

    // Initial render
    renderer.update(pathManager);
  </script>
</body>
</html>
